<div class="grid">
    <div class="col-12">
        <div class="card">
            <h5>User manager</h5>
            <ng-container *ngIf="formState == 'list'">
                <ng-container *ngTemplateOutlet="listLayout"></ng-container>
            </ng-container>
            <ng-container *ngIf="formState == 'new' || formState == 'edit'">
                <ng-container *ngTemplateOutlet="formLayout"></ng-container>
            </ng-container>
        </div>
    </div>
</div>

<ng-template #formLayout>
    <h5><span *ngIf="formState == 'new'">New</span><span *ngIf="formState == 'edit'">Edit</span> user</h5>
    <p-messages [(value)]="msgs"></p-messages>
    <form class="p-fluid" [formGroup]="form">
        <h6>UserName:</h6>
        <span class="p-float-label">
            <input pInputText formControlName="userName" type="text" [ngClass]="{
                'ng-invalid': form.get('userName')?.invalid && (form.get('userName')?.dirty || form.get('userName')?.touched),
                'ng-dirty': form.get('userName')?.invalid && (form.get('userName')?.dirty || form.get('userName')?.touched)
            }" />
        </span>
        <ng-container
            *ngIf="form.get('userName')?.invalid && (form.get('userName')?.dirty || form.get('userName')?.touched)">
            <small id="userName-help" class="p-error" *ngIf="form.get('userName')?.errors?.['required']">UserName is
                required.</small>
        </ng-container>
        <ng-container *ngIf="formState == 'new'">
            <h6>Password:</h6>
            <span class="p-float-label">
                <input pInputText formControlName="password" type="password" [ngClass]="{
                    'ng-invalid': form.get('password')?.invalid && (form.get('password')?.dirty || form.get('password')?.touched),
                    'ng-dirty': form.get('password')?.invalid && (form.get('password')?.dirty || form.get('password')?.touched)
                }" />
            </span>
            <ng-container
                *ngIf="form.get('password')?.invalid && (form.get('password')?.dirty || form.get('password')?.touched)">
                <small id="password-help" class="p-error" *ngIf="form.get('password')?.errors?.['required']">Password is
                    required.</small>
            </ng-container>
            <h6>Retype Password:</h6>
            <span class="p-float-label">
                <input pInputText formControlName="retypePassword" type="password" [ngClass]="{
                    'ng-invalid': form.get('retypePassword')?.invalid && (form.get('retypePassword')?.dirty || form.get('retypePassword')?.touched),
                    'ng-dirty': form.get('retypePassword')?.invalid && (form.get('retypePassword')?.dirty || form.get('retypePassword')?.touched)
                }" />
            </span>
            <ng-container
                *ngIf="form.get('retypePassword')?.invalid && (form.get('retypePassword')?.dirty || form.get('retypePassword')?.touched)">
                <small id="retypePassword-help" class="p-error"
                    *ngIf="form.get('retypePassword')?.errors?.['required']">RetypePassword is
                    required.</small>
            </ng-container>
        </ng-container>
        <h6>Grant Connection Permission:</h6>
        <span class="p-float-label">
            <p-listbox [options]="connectionDataSource" optionLabel="label" [checkbox]="true" [filter]="true"
                [multiple]="true" formControlName="connectionPermissions" [ngClass]="{
                    'ng-invalid': form.get('connectionPermissions')?.invalid && (form.get('connectionPermissions')?.dirty || form.get('connectionPermissions')?.touched),
                    'ng-dirty': form.get('connectionPermissions')?.invalid && (form.get('connectionPermissions')?.dirty || form.get('connectionPermissions')?.touched)
                }"></p-listbox>
        </span>
    </form>
    <div class="form-footer">
        <button arial-label="button" pButton type="button" label="Save" icon="pi pi-save" class="p-button-info"
            [disabled]="form.invalid || processing" (click)="saveUser()"></button>
        <button arial-label="button" pButton type="button" label="Cancel" icon="pi pi-times" class="p-button-danger"
            (click)="cancel()"></button>
    </div>
</ng-template>

<ng-template #listLayout>
    <p-table #dt1 [value]="users" dataKey="id" [rows]="10" [loading]="loading" [rowHover]="true"
        styleClass="p-datatable-gridlines" [paginator]="true" sortField="server" [sortOrder]="1"
        [globalFilterFields]="['userName']" responsiveLayout="scroll">
        <ng-template pTemplate="caption">
            <div class="flex justify-content-between flex-column sm:flex-row">
                <button aria-label="button" pButton label="New" class="p-button-outlined mb-2" icon="pi pi-plus"
                    (click)="newUser()"></button>
                <span class="p-input-icon-left mb-2">
                    <i aria-hidden="true" class="pi pi-search"></i>
                    <input pInputText type="text" #filter (input)="dt1.filterGlobal($event.target.value, 'contains')"
                        placeholder="Search Keyword" class="w-full" />
                </span>
            </div>
        </ng-template>
        <ng-template pTemplate="header">
            <tr>
                <th scope="col">
                    <div class="flex justify-content-between align-items-center">
                        UserName
                    </div>
                </th>
                <th scope="col" style="width:15rem;">
                    Action
                </th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
            <tr>
                <td>{{item.userName}}</td>
                <td>
                    <button arial-label="button" pButton type="button" icon="pi pi-pencil"
                        class="p-button-rounded p-button-text" (click)="editUser(item)"></button>
                    <button arial-label="button" pButton type="button" icon="pi pi-trash"
                        class="p-button-rounded p-button-text p-button-danger"
                        (click)="deleteUser($event, item)"></button>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="7">No user found.</td>
            </tr>
        </ng-template>
        <ng-template pTemplate="loadingbody">
            <tr>
                <td colspan="7">Loading user data. Please wait.</td>
            </tr>
        </ng-template>
    </p-table>
</ng-template>

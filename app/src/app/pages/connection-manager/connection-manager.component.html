<div class="grid">
    <div class="col-12">
        <div class="card">
            <h5>Connection manager</h5>
            <ng-container *ngIf="formState == 'list'">
                <ng-container *ngTemplateOutlet="listLayout"></ng-container>
            </ng-container>
            <ng-container *ngIf="formState == 'new' || formState == 'edit'">
                <ng-container *ngTemplateOutlet="formLayout"></ng-container>
            </ng-container>
        </div>
    </div>
</div>

<ng-template #formLayout>
    <h5><span *ngIf="formState == 'new'">New</span><span *ngIf="formState == 'edit'">Edit</span> connection</h5>
    <p-messages [(value)]="msgs"></p-messages>
    <form class="p-fluid" [formGroup]="form">
        <h6>Connection name:</h6>
        <span class="p-float-label">
            <input pInputText formControlName="name" type="text" [ngClass]="{
                'ng-invalid': form.get('name')?.invalid && (form.get('name')?.dirty || form.get('name')?.touched),
                'ng-dirty': form.get('name')?.invalid && (form.get('name')?.dirty || form.get('name')?.touched)
            }" />
        </span>
        <ng-container *ngIf="form.get('name')?.invalid && (form.get('name')?.dirty || form.get('name')?.touched)">
            <small id="name-help" class="p-error" *ngIf="form.get('name')?.errors?.['required']">Name is
                required.</small>
        </ng-container>
        <h6>Server:</h6>
        <span class="p-float-label">
            <input pInputText formControlName="server" type="text" placeholder="14.225.3.52:2379" [ngClass]="{
                'ng-invalid': form.get('server')?.invalid && (form.get('server')?.dirty || form.get('server')?.touched),
                'ng-dirty': form.get('server')?.invalid && (form.get('server')?.dirty || form.get('server')?.touched)
            }" />
        </span>
        <ng-container *ngIf="form.get('server')?.invalid && (form.get('server')?.dirty || form.get('server')?.touched)">
            <small id="server-help" class="p-error" *ngIf="form.get('server')?.errors?.['required']">Server is
                required.</small>
        </ng-container>
        <h6>Enable Authenticated:</h6>
        <p-inputSwitch formControlName="enableAuthenticated" (onChange)="handleChangeEnableAuthenticated($event)">
        </p-inputSwitch>
        <ng-container *ngIf="!form.get('userName')?.disabled">
            <h6>Username:</h6>
            <span class="p-float-label">
                <input pInputText formControlName="userName" type="text" placeholder="root" [ngClass]="{
                    'ng-invalid': form.get('userName')?.invalid && (form.get('userName')?.dirty || form.get('userName')?.touched),
                    'ng-dirty': form.get('userName')?.invalid && (form.get('userName')?.dirty || form.get('userName')?.touched)
                }" />
            </span>
            <ng-container
                *ngIf="form.get('userName')?.invalid && (form.get('userName')?.dirty || form.get('userName')?.touched)">
                <small id="userName-help" class="p-error" *ngIf="form.get('userName')?.errors?.['required']">Username is
                    required.</small>
            </ng-container>
        </ng-container>
        <ng-container *ngIf="!form.get('password')?.disabled">
            <h6>Password:</h6>
            <span class="p-float-label">
                <input pInputText formControlName="password" type="password" placeholder="your password..." [ngClass]="{
                'ng-invalid': form.get('password')?.invalid && (form.get('password')?.dirty || form.get('password')?.touched),
                'ng-dirty': form.get('password')?.invalid && (form.get('password')?.dirty || form.get('password')?.touched)
            }" />
            </span>
            <ng-container
                *ngIf="form.get('password')?.invalid && (form.get('password')?.dirty || form.get('password')?.touched)">
                <small id="password-help" class="p-error" *ngIf="form.get('password')?.errors?.['required']">Password is
                    required.</small>
            </ng-container>
        </ng-container>
        <ng-container>
            <h6>Agent Domain:</h6>
            <span class="p-float-label">
                <input pInputText formControlName="agentDomain" type="agentDomain"
                    placeholder="type your custom agent here..." [ngClass]="{
                'ng-invalid': form.get('agentDomain')?.invalid && (form.get('agentDomain')?.dirty || form.get('agentDomain')?.touched),
                'ng-dirty': form.get('agentDomain')?.invalid && (form.get('agentDomain')?.dirty || form.get('agentDomain')?.touched)
            }" />
            </span>
        </ng-container>
        <h6>Insecure:</h6>
        <p-inputSwitch formControlName="insecure"></p-inputSwitch>
    </form>
    <div class="form-footer">
        <button arial-label="button" pButton type="button" label="Check connection" icon="pi pi-check"
            [disabled]="form.invalid || processing" class="p-button-success" (click)="checkConnection()"></button>
        <button arial-label="button" pButton type="button" label="Save" icon="pi pi-save" class="p-button-info"
            [disabled]="form.invalid || processing" (click)="saveConnection()"></button>
        <button arial-label="button" pButton type="button" label="Cancel" icon="pi pi-times" class="p-button-danger"
            (click)="cancelConnection()"></button>
    </div>
</ng-template>

<ng-template #listLayout>
    <p-table #dt1 [value]="connections" dataKey="id" [rows]="10" [loading]="loading" [rowHover]="true"
        styleClass="p-datatable-gridlines" [paginator]="true" sortField="server" [sortOrder]="1"
        [globalFilterFields]="['name','server','userName','createdAt']" responsiveLayout="scroll">
        <ng-template pTemplate="caption">
            <div class="flex justify-content-between flex-column sm:flex-row">
                <button aria-label="button" pButton label="New" class="p-button-outlined mb-2" icon="pi pi-plus"
                    (click)="newConnection()"></button>
                <span class="p-input-icon-left mb-2">
                    <i aria-hidden="true" class="pi pi-search"></i>
                    <input pInputText type="text" #filter (input)="dt1.filterGlobal($event.target.value, 'contains')"
                        placeholder="Search Keyword" class="w-full" />
                </span>
            </div>
        </ng-template>
        <ng-template pTemplate="header">
            <tr>
                <th scope="col">
                    <div class="flex justify-content-between align-items-center">
                        Name
                    </div>
                </th>
                <th scope="col">
                    <div class="flex justify-content-between align-items-center">
                        Server
                    </div>
                </th>
                <th scope="col">
                    <div class="flex justify-content-between align-items-center">
                        User
                    </div>
                </th>
                <th scope="col">
                    <div class="flex justify-content-between align-items-center">
                        Created At
                    </div>
                </th>
                <th scope="col" style="width:15rem;">
                    Action
                </th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
            <tr>
                <td>{{item.name}}</td>
                <td>{{item.server}}</td>
                <td>{{item.userName}}</td>
                <td>{{item.createdAt | date:'d/M/y h:m'}}</td>
                <td>
                    <button arial-label="button" pButton type="button" icon="pi pi-arrow-up-right"
                        class="p-button-rounded p-button-text" (click)="onSelectConnection(item)"></button>
                    <button arial-label="button" pButton type="button" icon="pi pi-pencil"
                        class="p-button-rounded p-button-text" (click)="editConnection(item)"></button>
                    <button arial-label="button" pButton type="button" icon="pi pi-trash"
                        class="p-button-rounded p-button-text p-button-danger"
                        (click)="deleteConnection($event, item)"></button>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="7">No connection found.</td>
            </tr>
        </ng-template>
        <ng-template pTemplate="loadingbody">
            <tr>
                <td colspan="7">Loading connection data. Please wait.</td>
            </tr>
        </ng-template>
    </p-table>
</ng-template>
